# Docker: CVE-Search installation

## References
Links:
* https://cve-search.github.io/cve-search/
* https://github.com/cve-search/CVE-Search-Docker
* REST API: https://cve.circl.lu/api/

Dockerized CVE-Search is composed of three images:
* cve-search
* Mongo
* Redis


## Request nvd.ndis API key 
Link: https://nvd.nist.gov/developers/request-an-api-key

An email will provide a link to validate the request and get the API key.


## Clone cve-search

```bash
$ mkdir -p $HOME/AlvoHive/cve-search
$ cd $HOME/AlvoHive/cve-search
$> git clone https://github.com/cve-search/CVE-Search-Docker.git
```

## Configure docker-compose.yml
```bash
$> cd CVE-Search-Docker
$> vi docker-compose.yml
```
Changes done:
* Added environment variable NVD_NIST_API_KEY to service cve_search.
* Added environment variable TZ to the three services.
* Service cve_search port changed from 443 to 8443. Apache will use 443.


``` yaml
services:

  cve_search:
    image: cve_search
    build:
      context: .
      dockerfile: docker/images/cve_search/dockerfile-cve_search
      args:
        - REPO=cve-search/cve-search
        - BRANCH=master
    hostname: cve_search
    depends_on:
      - redis
      - mongo
    restart: always
    environment:
      - PYTHONUNBUFFERED=TRUE
      - WORKER_SIZE=1
      - MONGODB_HOST=mongo
      - NVD_NIST_API_KEY=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
      - TZ=Europe/Paris
    ports:
      - '8443:5000'
    networks:
      - frontend
      - backend

  redis:
    image: cve_search-redis
    hostname: redis
    restart: always
    environment:
      - TZ=Europe/Paris
    build:
      context: .
      dockerfile: docker/images/redis/dockerfile-redis
    volumes:
      - "./.cve_search_data/cve_search_redis:/data"
    expose:
      - 6379
    networks:
      - backend

  mongo:
    image: cve_search-mongo
    hostname: mongo
    restart: always
    environment:
      - TZ=Europe/Paris
    build:
      context: .
      dockerfile: docker/images/mongodb/dockerfile-mongo
    volumes:
      - "./.cve_search_data/cve_search_mongodb:/data/db"
    expose:
      - 27017
    networks:
      - backend

networks:
  frontend:
  backend:
```

## Start containers

Current directory must contain the docker-compose.yml.

``` bash
$> docker compose up -d
$> docker ps
```

Will show the 3 containers:
```
CONTAINER ID  IMAGE                              COMMAND               CREATED       STATUS         PORTS                   NAMES
2e057ed5ab65  localhost/cve_search-redis:latest  redis-server          16 hours ago  Up 30 minutes                          cve-search-docker_redis_1
bdb7e96aa128  localhost/cve_search-mongo:latest  mongod                16 hours ago  Up 30 minutes                          cve-search-docker_mongo_1
be45686513a8  localhost/cve_search:latest        python /app/web/i...  16 hours ago  Up 30 minutes  0.0.0.0:8443->5000/tcp  cve-search-docker_cve_search_1
```

## Test on Windows

First test: https://localhost:8443\
Will show CVEs only up to January 2024 or so.



## Update CVE-search DBs

From WSL:
```bash
$> docker exec -it cve-search-docker_cve_search_1 bash
```
* **-it** : interactive.
* **cve-search-docker_cve_search_1** : container name.
* **bash** : command to start.

Now, we are inside the container:
```bash
root@cve_search:/app#
```

Initialize the DB with all the up-to-date-data.\
To be executed only once:
``` bash
root@cve_search:/app# /app/sbin/db_updater.py -ci -f
```
Will take a long time.

Testing the the very last CVEs are now available: https://localhost:8443



## Stoppping CVE-Search containers

Current directory must contain the docker-compose.yml.

``` bash
$> docker compose stop mongo redis cve_search
```
or
``` bash
$> docker compose stop mongo
```