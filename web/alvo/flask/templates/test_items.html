<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid.js with Flask</title>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
</head>
<body>
    <div id="add-item-form">
        <h2>Add New Item</h2>
        <form id="new-item-form">
            <label for="new-name">Name:</label>
            <input type="text" id="new-name" name="name" required>
            <label for="new-description">Description:</label>
            <input type="text" id="new-description" name="description" required>
            <button type="submit">Add Item</button>
        </form>
    </div>
    <div id="wrapper"></div>
    <button id="commit-btn">Commit Changes</button>
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let modifiedData = {};

            const grid = new gridjs.Grid({
                columns: [
                    { id: 'id', name: 'ID' },
                    { id: 'name', name: 'Name' },
                    { id: 'description', name: 'Description' },
                    {
                        name: 'Actions',
                        formatter: (cell, row) => {
                            return gridjs.html(`
                                <button class="delete-btn" data-id="${row.cells[0].data}">Delete</button>
                            `);
                        }
                    }
                ],
                server: {
                    url: 'https://localhost/test_items/items',
                    then: data => data.map(item => [
                        item.id,
                        gridjs.html(`<input type="text" value="${item.name}" data-id="${item.id}" data-field="name">`),
                        gridjs.html(`<input type="text" value="${item.description}" data-id="${item.id}" data-field="description">`)
                    ])
                }
            }).render(document.getElementById('wrapper'));

            document.getElementById('wrapper').addEventListener('change', (e) => {
                if (e.target.tagName === 'INPUT') {
                    const id = e.target.getAttribute('data-id');
                    const field = e.target.getAttribute('data-field');
                    const value = e.target.value;

                    if (!modifiedData[id]) {
                        modifiedData[id] = { id: id };
                    }

                    modifiedData[id][field] = value;
                }
            });

            document.getElementById('wrapper').addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = e.target.getAttribute('data-id');
                    await fetch(`https://localhost/test_items/items/${id}`, {
                        method: 'DELETE'
                    });
                    grid.updateConfig({}).forceRender();
                }
            });

            document.getElementById('commit-btn').addEventListener('click', async () => {
                const data = Object.values(modifiedData);
                await fetch('https://localhost/test_items/items/bulk_update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                grid.updateConfig({}).forceRender();
                modifiedData = {};  // Reset modified data after commit
            });

            document.getElementById('new-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-name').value;
                const description = document.getElementById('new-description').value;

                const response = await fetch('https://localhost/test_items/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    grid.updateConfig({}).forceRender();
                    document.getElementById('new-item-form').reset();
                } else {
                    alert('Failed to add item.');
                }
            });
        });
    </script>
</body>
</html>
